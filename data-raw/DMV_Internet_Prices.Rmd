---
title: "DMV_Internet_Prices"
output: html_document
---

```{r}
library(sf)
library(tidyverse)
library(tmap)
library(tmaptools)
library(tigris)
library(tidycensus)
library(rmapshaper)
library(matrixStats)
library(SpatialAcc)
library(reticulate)
library(dplyr)
library(tidygeocoder)
library(readxl)
```


```{r}
con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
va_broadband_now_prices <- st_read(con, query = "SELECT * FROM dc_digital_communications.va_bg_broadband_now_2021_internet_package_price")
dc_broadband_now_prices <- st_read(con, query = "SELECT * FROM dc_digital_communications.dc_bg_broadband_now_2021_internet_package_price")
md_broadband_now_prices <- st_read(con, query = "SELECT * FROM dc_digital_communications.md_bg_broadband_now_2021_internet_package_price")
dmv_broadband_now_prices <- st_read(con, query = "SELECT * FROM dc_digital_communications.dmv_bg_broadband_now_2021_internet_package_price")
dbDisconnect(con)


md_broadband_now_prices <- md_broadband_now_prices %>%
  mutate(block_group = as.character(block_group),
         tract = substr(block_group, 1, 11),
         county = substr(block_group, 1, 5))
va_broadband_now_prices <- va_broadband_now_prices %>%
  mutate(block_group = as.character(block_group),
         tract = substr(block_group, 1, 11),
         county = substr(block_group, 1, 5))
dc_broadband_now_prices <- dc_broadband_now_prices %>%
  mutate(block_group = as.character(block_group),
         tract = substr(block_group, 1, 11),
         county = substr(block_group, 1, 5))
dmv_broadband_now_prices <- dmv_broadband_now_prices %>%
  mutate(block_group = as.character(block_group),
         tract = substr(block_group, 1, 11),
         county = substr(block_group, 1, 5))
```



```{r}
# VIRGINIA
va_100_min_prices <- va_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA),) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -down_minus_100, n = 1) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_100 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract))
va_100_min_prices.2 <- va_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_100_plus = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(va_100_min_prices)
va_100_med_and_min_prices <- va_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -down_minus_100, n = 1) %>%
  group_by(tract) %>%
  summarize(med_price_100 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(va_100_min_prices.2)
va_min_prices <- va_broadband_now_prices %>% # find minimum price for 25 in each block group, then median price among those in tract
  mutate(down_minus_25 = ifelse(download >= 25, download - 25, NA)) %>%
  drop_na(down_minus_25) %>%
  mutate(down_minus_100 = ifelse(download <= 100, 100 - download, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_25 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(va_100_med_and_min_prices)
va_med_and_min_prices <- va_broadband_now_prices %>%
  mutate(down_minus_25 = ifelse(download >= 25, download - 25, NA)) %>%
  drop_na(down_minus_25) %>%
  mutate(down_minus_100 = ifelse(download <= 100, 100 - download, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  summarize(price = median(price, na.rm = T), tract = tract) %>%
  group_by(tract) %>%
  summarize(med_price_25 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(va_min_prices)

# MARYLAND
md_100_min_prices <- md_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -down_minus_100, n = 1) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_100 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract))
md_100_min_prices.2 <- md_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_100_plus = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(md_100_min_prices)
md_100_med_and_min_prices <- md_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -down_minus_100, n = 1) %>%
  group_by(tract) %>%
  summarize(med_price_100 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(md_100_min_prices.2)
md_min_prices <- md_broadband_now_prices %>% # find minimum price for 25 in each block group, then median price among those in tract
  mutate(down_minus_25 = ifelse(download >= 25, download - 25, NA)) %>%
  drop_na(down_minus_25) %>%
  mutate(down_minus_100 = ifelse(download <= 100, 100 - download, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_25 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(md_100_med_and_min_prices)
md_med_and_min_prices <- md_broadband_now_prices %>%
  mutate(down_minus_25 = ifelse(download >= 25, download - 25, NA)) %>%
  drop_na(down_minus_25) %>%
  mutate(down_minus_100 = ifelse(download <= 100, 100 - download, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  summarize(price = median(price, na.rm = T), tract = tract) %>%
  group_by(tract) %>%
  summarize(med_price_25 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(md_min_prices)

# DC
dc_100_min_prices <- dc_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -down_minus_100, n = 1) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_100 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract))
dc_100_min_prices.2 <- dc_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_100_plus = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(dc_100_min_prices)
dc_100_med_and_min_prices <- dc_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -down_minus_100, n = 1) %>%
  group_by(tract) %>%
  summarize(med_price_100 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(dc_100_min_prices.2)
dc_min_prices <- dc_broadband_now_prices %>% # find minimum price for 25 in each block group, then median price among those in tract
  mutate(down_minus_25 = ifelse(download >= 25, download - 25, NA)) %>%
  drop_na(down_minus_25) %>%
  mutate(down_minus_100 = ifelse(download <= 100, 100 - download, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_25 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(dc_100_med_and_min_prices)
dc_med_and_min_prices <- dc_broadband_now_prices %>%
  mutate(down_minus_25 = ifelse(download >= 25, download - 25, NA)) %>%
  drop_na(down_minus_25) %>%
  mutate(down_minus_100 = ifelse(download <= 100, 100 - download, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  summarize(price = median(price, na.rm = T), tract = tract) %>%
  group_by(tract) %>%
  summarize(med_price_25 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(dc_min_prices)

# DMV
dmv_100_min_prices <- dmv_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -down_minus_100, n = 1) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_100 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract))
dmv_100_min_prices.2 <- dmv_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_100_plus = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(dmv_100_min_prices)
dmv_100_med_and_min_prices <- dmv_broadband_now_prices %>%
  mutate(down_minus_100 = ifelse(download >= 100, download - 100, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -down_minus_100, n = 1) %>%
  group_by(tract) %>%
  summarize(med_price_100 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(dmv_100_min_prices.2)
dmv_min_prices <- dmv_broadband_now_prices %>% # find minimum price for 25 in each block group, then median price among those in tract
  mutate(down_minus_25 = ifelse(download >= 25, download - 25, NA)) %>%
  drop_na(down_minus_25) %>%
  mutate(down_minus_100 = ifelse(download <= 100, 100 - download, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  slice_max(order_by = -price, n = 1)  %>%
  group_by(tract) %>%
  summarize(min_price_25 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(dmv_100_med_and_min_prices)
dmv_med_and_min_prices <- dmv_broadband_now_prices %>%
  mutate(down_minus_25 = ifelse(download >= 25, download - 25, NA)) %>%
  drop_na(down_minus_25) %>%
  mutate(down_minus_100 = ifelse(download <= 100, 100 - download, NA)) %>%
  drop_na(down_minus_100) %>%
  group_by(block_group) %>%
  summarize(price = median(price, na.rm = T), tract = tract) %>%
  group_by(tract) %>%
  summarize(med_price_25 = median(price, na.rm = T)) %>%
  mutate(tract = as.character(tract)) %>%
  merge(dmv_min_prices)
```


```{r}
dmv_prices <- dmv.tr[substr(dmv.tr$GEOID, 1, 5) %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),] %>% left_join(dmv_med_and_min_prices, by = c("GEOID" = "tract"))
va_prices <- va.tr %>% left_join(va_med_and_min_prices, by = c("GEOID" = "tract"))
dc_prices <- dc.tr %>% left_join(dc_med_and_min_prices, by = c("GEOID" = "tract"))
md_prices <- md.tr %>% left_join(md_med_and_min_prices, by = c("GEOID" = "tract"))

tm_shape(dmv_prices, unit = "mi") +
  tm_polygons(col = "med_price_25",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Percent (%)",
              breaks = c(0, 5, 10, 20, 30, 65),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "Median Price for 25-100 Download",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")

tm_shape(dmv_prices, unit = "mi") +
  tm_polygons(col = "min_price_25",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Price ($)",
              breaks = c(0, 5, 10, 20, 30, 65),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "Minimum Price for 25-100 Download",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")

tm_shape(dmv_prices, unit = "mi") +
  tm_polygons(col = "med_price_100",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Price ($)",
              breaks = c(0, 5, 10, 20, 30, 65),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "Median Price for 100 Download",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")

tm_shape(dmv_prices, unit = "mi") +
  tm_polygons(col = "min_price_100",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Percent (%)",
              breaks = c(0, 5, 10, 20, 30, 65),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "Minimum Price for 100 Download",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")

tm_shape(dmv_prices, unit = "mi") +
  tm_polygons(col = "min_price_100_plus",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Price ($)",
              breaks = c(0, 5, 10, 20, 30, 65),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "Minimum Price for 100+ Download",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")
```


```{r}
ncr.isp.price <- st_drop_geometry(dmv_prices) %>% mutate(year = 2021, region_type = "tract", measure_type = "price", measure_units = "dollars") %>%
  gather(measure, value, c(med_price_25, min_price_25, med_price_100, min_price_100_plus, min_price_100)) %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  select("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  drop_na()

va.isp.price <- st_drop_geometry(va_prices) %>% mutate(year = 2021, region_type = "tract", measure_type = "price", measure_units = "dollars") %>%
  gather(measure, value, c(med_price_25, min_price_25, med_price_100, min_price_100_plus, min_price_100)) %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  select("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  drop_na()

dc.isp.price <- st_drop_geometry(dc_prices) %>% mutate(year = 2021, region_type = "tract", measure_type = "price", measure_units = "dollars") %>%
  gather(measure, value, c(med_price_25, min_price_25, med_price_100, min_price_100_plus, min_price_100)) %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  select("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  drop_na()

md.isp.price <- st_drop_geometry(md_prices) %>% mutate(year = 2021, region_type = "tract", measure_type = "price", measure_units = "dollars") %>%
  gather(measure, value, c(med_price_25, min_price_25, med_price_100, min_price_100_plus, min_price_100)) %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  select("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  drop_na()

md.isp.price
```


```{r}
con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
dc_dbWriteTable(con, "dc_digital_communications", "ncr_tr_broadband_now_2021_internet_package_price", ncr.isp.price)
dc_dbWriteTable(con, "dc_digital_communications", "va_tr_broadband_now_2021_internet_package_price", va.isp.price)
dc_dbWriteTable(con, "dc_digital_communications", "dc_tr_broadband_now_2021_internet_package_price", dc.isp.price)
dc_dbWriteTable(con, "dc_digital_communications", "md_tr_broadband_now_2021_internet_package_price", md.isp.price)
dbDisconnect(con)

# va_bg_broadband_now_2021_internet_package_price
```

# looking at median income in tracts!
```{r}
dmv.tr <- get_acs(geography = "tract",
                 year = 2019,
                 variables = c(median_household_income = "B19013_001"),
                 state = c("VA", "DC", "MD"),
                 survey = "acs5",
                 output = "wide",
                 geometry = TRUE)

ncr.tr <- dmv.tr[substr(dmv.tr$GEOID, 1, 5) %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]
ncr.inc_and_price <- left_join(ncr.tr[,c("GEOID", "median_household_incomeE")], ncr.isp.price, by = c("GEOID" = "geoid")) %>%
  mutate(perc_annual_income = ifelse(value / median_household_incomeE * 100 * 12 > 0, value / median_household_incomeE * 100 * 12, NA)) %>%
  select(-c(median_household_incomeE, value)) %>%
  mutate(measure = paste0("perc_income_", measure), measure_type = "percent", measure_units = as.character(NA)) %>%
  rename(value = perc_annual_income, geoid = GEOID) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")
ncr.inc_and_price.2 <- st_drop_geometry(ncr.inc_and_price) %>% drop_na(value)
ncr.inc_and_price.3 <- st_drop_geometry(ncr.tr) %>%
  mutate(value = 64 / median_household_incomeE * 100 * 12, measure = "perc_income_avg_nat_package",
         measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "tract") %>%
  select(-c(median_household_incomeE, median_household_incomeM)) %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>% rbind(ncr.inc_and_price.2)

# VA
va.tr <- dmv.tr[substr(dmv.tr$GEOID, 1, 2) == "51",]
va.inc_and_price <- left_join(va.tr[,c("GEOID", "median_household_incomeE")], va.isp.price, by = c("GEOID" = "geoid")) %>%
  mutate(perc_annual_income = ifelse(value / median_household_incomeE * 100 * 12 > 0, value / median_household_incomeE * 100 * 12, NA)) %>%
  select(-c(median_household_incomeE, value)) %>%
  mutate(measure = paste0("perc_income_", measure), measure_type = "percent", measure_units = as.character(NA)) %>%
  rename(value = perc_annual_income, geoid = GEOID) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")
va.inc_and_price.2 <- st_drop_geometry(va.inc_and_price) %>% drop_na(value)
va.inc_and_price.3 <- st_drop_geometry(va.tr) %>%
  mutate(value = 64 / median_household_incomeE * 100 * 12, measure = "perc_income_avg_nat_package",
         measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "tract") %>%
  select(-c(median_household_incomeE, median_household_incomeM)) %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>% rbind(va.inc_and_price.2)

# DC
dc.tr <- dmv.tr[substr(dmv.tr$GEOID, 1, 2) == "11",]
dc.inc_and_price <- left_join(dc.tr[,c("GEOID", "median_household_incomeE")], dc.isp.price, by = c("GEOID" = "geoid")) %>%
  mutate(perc_annual_income = ifelse(value / median_household_incomeE * 100 * 12 > 0, value / median_household_incomeE * 100 * 12, NA)) %>%
  select(-c(median_household_incomeE, value)) %>%
  mutate(measure = paste0("perc_income_", measure), measure_type = "percent", measure_units = as.character(NA)) %>%
  rename(value = perc_annual_income, geoid = GEOID) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")
dc.inc_and_price.2 <- st_drop_geometry(dc.inc_and_price) %>% drop_na(value)
dc.inc_and_price.3 <- st_drop_geometry(dc.tr) %>%
  mutate(value = 64 / median_household_incomeE * 100 * 12, measure = "perc_income_avg_nat_package",
         measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "tract") %>%
  select(-c(median_household_incomeE, median_household_incomeM)) %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>% rbind(dc.inc_and_price.2)

# MD
md.tr <- dmv.tr[substr(dmv.tr$GEOID, 1, 2) == "24",]
md.inc_and_price <- left_join(md.tr[,c("GEOID", "median_household_incomeE")], md.isp.price, by = c("GEOID" = "geoid")) %>%
  mutate(perc_annual_income = ifelse(value / median_household_incomeE * 100 * 12 > 0, value / median_household_incomeE * 100 * 12, NA)) %>%
  select(-c(median_household_incomeE, value)) %>%
  mutate(measure = paste0("perc_income_", measure), measure_type = "percent", measure_units = as.character(NA)) %>%
  rename(value = perc_annual_income, geoid = GEOID) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")
md.inc_and_price.2 <- st_drop_geometry(md.inc_and_price) %>% drop_na(value)
md.inc_and_price.3 <- st_drop_geometry(md.tr) %>%
  mutate(value = 64 / median_household_incomeE * 100 * 12, measure = "perc_income_avg_nat_package",
         measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "tract") %>%
  select(-c(median_household_incomeE, median_household_incomeM)) %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>% rbind(md.inc_and_price.2)
```


```{r}
perc.ann_inc.100.plus <- ncr.inc_and_price[ncr.inc_and_price$measure == "min_price_100_plus",]
perc.ann_inc.100.plus.2 <- left_join(ncr.tr, st_drop_geometry(perc.ann_inc.100.plus)[, c("GEOID", "perc_annual_income")], by = "GEOID")
tm_shape(perc.ann_inc.100.plus.2, unit = "mi") +
  tm_polygons(col = "perc_annual_income",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Percent (%)",
              breaks = c(0, 1, 5, 20),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "Percent Income for Cheapest 100+ Mbps Package",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")

perc.ann_inc.25to100 <- ncr.inc_and_price[ncr.inc_and_price$measure == "min_price_25",]
perc.ann_inc.25to100.2 <- left_join(ncr.tr, st_drop_geometry(perc.ann_inc.25to100)[, c("GEOID", "perc_annual_income")], by = "GEOID")
tm_shape(perc.ann_inc.25to100.2, unit = "mi") +
  tm_polygons(col = "perc_annual_income",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Percent (%)",
              breaks = c(0, 1, 5, 20),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "Percent Income for Cheapest 25-100 Mbps Package",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")

perc.ann_inc.using_average <- ncr.tr %>% mutate(perc2 = 64 / median_household_incomeE * 100 * 12)
perc.ann_inc.using_average.2 <- left_join(ncr.tr, st_drop_geometry(perc.ann_inc.using_average)[, c("GEOID", "perc2")], by = "GEOID")
tm_shape(perc.ann_inc.using_average.2, unit = "mi") +
  tm_polygons(col = "perc2",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Percent (%)",
              breaks = c(0, 1, 5, 20),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "Percent Income on Average Internet Package",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")
```


# SNAP, Medicaid, public assistance programs - B09010_001E = Living in household with Supplemental Security Income (SSI), cash public assistance income, or Food Stamps/SNAP in the past 12 months

<!-- B19057_001E ?? public assist income -->
<!-- B19123_002E - CPA/SNAP -->
```{r}
dmv.tr.2 <- get_acs(geography = "tract",
                    year = 2019,
                    variables = c(SSI_CPA_SNAP = "B09010_002",
                                  pop = "B01003_001",
                                  pop2 = "B09010_001",
                                  pop3 = "B09010_008"),
                    state = c("VA", "DC", "MD"),
                    survey = "acs5",
                    output = "wide",
                    geometry = TRUE)

ncr.tr.2 <- dmv.tr.2[substr(dmv.tr.2$GEOID, 1, 5) %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),] %>%
  mutate(perc_w_aid = 100 * SSI_CPA_SNAPE / popE, perc_w_aid2 = 100 * SSI_CPA_SNAPE / pop2E)

tm_shape(ncr.tr.2, unit = "mi") +
  tm_polygons(col = "perc_w_aid",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Percent (%)",
              breaks = c(0, 1, 5, 20),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "% with SSI, cash public assistance income, or SNAP",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")

tm_shape(ncr.tr.2, unit = "mi") +
  tm_polygons(col = "perc_w_aid2",
              style = "fisher",
              palette = "Blues",
              border.alpha = 0,
              title = "Percent (%)",
              breaks = c(0, 1, 5, 20),
              colorNA = "grey",
              textNA = "Missing",
              showNA = TRUE) +
  tm_scale_bar(position = c("left", "top")) +
  tm_shape(dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]) +
  tm_polygons(alpha = 0) +
  tm_layout(main.title = "% with SSI, cash public assistance income, or SNAP",
            main.title.size = 0.95,
            frame = F,
            legend.outside = T,
            legend.outside.position = "right")

hist(dmv.tr.2$pop2E/dmv.tr.2$popE)
hist(dmv.tr.2$pop3E/dmv.tr.2$popE)

hist(dmv.tr.2$popE)

mean((dmv.tr.2$pop2E + dmv.tr.2$pop3E) / dmv.tr.2$popE, na.rm = T)
```


```{r}
con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
dc_dbWriteTable(con, "dc_digital_communications", "ncr_tr_sdad_2021_perc_income_on_internet", ncr.inc_and_price.3)
dc_dbWriteTable(con, "dc_digital_communications", "va_tr_sdad_2021_perc_income_on_internet", va.inc_and_price.3)
dc_dbWriteTable(con, "dc_digital_communications", "dc_tr_sdad_2021_perc_income_on_internet", dc.inc_and_price.3)
dc_dbWriteTable(con, "dc_digital_communications", "md_tr_sdad_2021_perc_income_on_internet", md.inc_and_price.3)
dbDisconnect(con)

# dc.inc_and_price.3
```


```{r}
dmv.tr <- get_acs(geography = "tract",
                 year = 2019,
                 variables = c(median_household_income = "B19013_001",
                               pop = "B01003_001"),
                 state = c("VA", "DC", "MD"),
                 survey = "acs5",
                 output = "wide",
                 geometry = TRUE)
ncr.tr <- dmv.tr[substr(dmv.tr$GEOID, 1, 5) %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]
va.tr <- dmv.tr[substr(dmv.tr$GEOID, 1, 2) == "51",]
dc.tr <- dmv.tr[substr(dmv.tr$GEOID, 1, 2) ==  "11",]
md.tr <- dmv.tr[substr(dmv.tr$GEOID, 1, 2) == "24",]

dmv.ct <- get_acs(geography = "county",
                 year = 2019,
                 variables = c(median_household_income = "B19013_001",
                               pop = "B01003_001"),
                 state = c("VA", "DC", "MD"),
                 survey = "acs5",
                 output = "wide",
                 geometry = TRUE)
ncr.ct <- dmv.ct[dmv.ct$GEOID %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]
va.ct <- dmv.ct[substr(dmv.ct$GEOID, 1, 2) == "51",]
dc.ct <- dmv.ct[substr(dmv.ct$GEOID, 1, 2) == "11",]
md.ct <- dmv.ct[substr(dmv.ct$GEOID, 1, 2) == "24",]

ncr.inc_and_price.ct <- merge(st_drop_geometry(ncr.tr), ncr.inc_and_price.3, by.x = "GEOID", by.y = "geoid") %>%
  mutate(county = substr(GEOID, 1, 5)) %>%
  group_by(county, measure) %>%
  summarize(value = sum(value * popE, na.rm = T) / sum(popE, na.rm = T)) %>%
  mutate(measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "county") %>%
  rename(geoid = county)
ncr.inc_and_price.ct.2 <- merge(st_drop_geometry(ncr.ct)[, c("GEOID", "NAME")], ncr.inc_and_price.ct, by.x = "GEOID", by.y = "geoid") %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")

va.inc_and_price.ct <- merge(st_drop_geometry(va.tr), va.inc_and_price.3, by.x = "GEOID", by.y = "geoid") %>%
  mutate(county = substr(GEOID, 1, 5)) %>%
  group_by(county, measure) %>%
  summarize(value = sum(value * popE, na.rm = T) / sum(popE, na.rm = T)) %>%
  mutate(measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "county") %>%
  rename(geoid = county)
va.inc_and_price.ct.2 <- merge(st_drop_geometry(va.ct)[, c("GEOID", "NAME")], va.inc_and_price.ct, by.x = "GEOID", by.y = "geoid") %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")

dc.inc_and_price.ct <- merge(st_drop_geometry(dc.tr), dc.inc_and_price.3, by.x = "GEOID", by.y = "geoid") %>%
  mutate(county = substr(GEOID, 1, 5)) %>%
  group_by(county, measure) %>%
  summarize(value = sum(value * popE, na.rm = T) / sum(popE, na.rm = T)) %>%
  mutate(measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "county") %>%
  rename(geoid = county)
dc.inc_and_price.ct.2 <- merge(st_drop_geometry(dc.ct)[, c("GEOID", "NAME")], dc.inc_and_price.ct, by.x = "GEOID", by.y = "geoid") %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")

md.inc_and_price.ct <- merge(st_drop_geometry(md.tr), md.inc_and_price.3, by.x = "GEOID", by.y = "geoid") %>%
  mutate(county = substr(GEOID, 1, 5)) %>%
  group_by(county, measure) %>%
  summarize(value = sum(value * popE, na.rm = T) / sum(popE, na.rm = T)) %>%
  mutate(measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "county") %>%
  rename(geoid = county)
md.inc_and_price.ct.2 <- merge(st_drop_geometry(md.ct)[, c("GEOID", "NAME")], md.inc_and_price.ct, by.x = "GEOID", by.y = "geoid") %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")

con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
dc_dbWriteTable(con, "dc_digital_communications", "ncr_ct_sdad_2021_perc_income_on_internet", ncr.inc_and_price.ct.2)
dc_dbWriteTable(con, "dc_digital_communications", "va_ct_sdad_2021_perc_income_on_internet", va.inc_and_price.ct.2)
dc_dbWriteTable(con, "dc_digital_communications", "dc_ct_sdad_2021_perc_income_on_internet", dc.inc_and_price.ct.2)
dc_dbWriteTable(con, "dc_digital_communications", "md_ct_sdad_2021_perc_income_on_internet", md.inc_and_price.ct.2)
dbDisconnect(con)
```


```{r}
health_district <- read.csv("/project/biocomplexity/sdad/projects_data/vdh/va_county_to_hd.csv")
health_district$county_id <- as.character(health_district$county_id)

con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
health_district_geoids <- st_read(con, query = "SELECT * FROM dc_common.va_hd_sdad_2021_virginia_health_district_geoids")
dbDisconnect(con)
health_district_2 <- left_join(health_district, health_district_geoids, by = c("health_district" = "region_name"))

va.inc_and_price.hd <- merge(health_district_2, va.inc_and_price.ct.2, by.x = "county_id", by.y = "geoid") %>%
  merge(st_drop_geometry(va.ct), by.x = "county_id", by.y = "GEOID") %>%
  group_by(measure, health_district) %>%
  summarize(value = sum(value * popE, na.rm = T) / sum(popE, na.rm = T)) %>%
  mutate(measure_type = "percent", measure_units = as.character(NA), year = 2021, region_type = "health district") %>%
  rename(region_name = health_district) %>% merge(health_district_geoids[c("region_name", "geoid")], by = "region_name") %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")

con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
dc_dbWriteTable(con, "dc_digital_communications", "va_hd_sdad_2021_perc_income_on_internet", va.inc_and_price.hd)
dbDisconnect(con)

# va.inc_and_price.hd
```


```{r}
dmv.bg <- get_acs(geography = "block group",
                 year = 2019,
                 variables = c(median_household_income = "B19013_001",
                               pop = "B01003_001"),
                 state = c("VA", "DC", "MD"),
                 survey = "acs5",
                 output = "wide",
                 geometry = TRUE)
ncr.bg <- dmv.bg[substr(dmv.bg$GEOID, 1, 5) %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]
va.bg <- dmv.bg[substr(dmv.bg$GEOID, 1, 2) == "51",]
dc.bg <- dmv.bg[substr(dmv.bg$GEOID, 1, 2) ==  "11",]
md.bg <- dmv.bg[substr(dmv.bg$GEOID, 1, 2) == "24",]


ncr.bg.price_inc <- st_drop_geometry(ncr.bg) %>%
  mutate(tract = substr(GEOID, 1, 11)) %>%
  merge(st_drop_geometry(dmv_prices)[, c("GEOID", "med_price_25", "min_price_25", "med_price_100", "min_price_100_plus", "min_price_100")], by.x = "tract", by.y = "GEOID") %>% 
  gather(measure, value, c(med_price_25, min_price_25, med_price_100, min_price_100_plus, min_price_100)) %>%
  mutate(perc_annual_income = ifelse(value / median_household_incomeE * 100 * 12 > 0, value / median_household_incomeE * 100 * 12, NA)) %>%
  select(-c(median_household_incomeE, value, median_household_incomeM, popE, popM, tract)) %>%
  mutate(measure = paste0("perc_income_", measure), measure_type = "percent", measure_units = as.character(NA), region_type = "block group", year = 2021) %>%
  rename(value = perc_annual_income, geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  drop_na(value)

va.bg.price_inc <- st_drop_geometry(va.bg) %>%
  mutate(tract = substr(GEOID, 1, 11)) %>%
  merge(st_drop_geometry(va_prices)[, c("GEOID", "med_price_25", "min_price_25", "med_price_100", "min_price_100_plus", "min_price_100")], by.x = "tract", by.y = "GEOID") %>% 
  gather(measure, value, c(med_price_25, min_price_25, med_price_100, min_price_100_plus, min_price_100)) %>%
  mutate(perc_annual_income = ifelse(value / median_household_incomeE * 100 * 12 > 0, value / median_household_incomeE * 100 * 12, NA)) %>%
  select(-c(median_household_incomeE, value, median_household_incomeM, popE, popM, tract)) %>%
  mutate(measure = paste0("perc_income_", measure), measure_type = "percent", measure_units = as.character(NA), region_type = "block group", year = 2021) %>%
  rename(value = perc_annual_income, geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  drop_na(value)

dc.bg.price_inc <- st_drop_geometry(dc.bg) %>%
  mutate(tract = substr(GEOID, 1, 11)) %>%
  merge(st_drop_geometry(dc_prices)[, c("GEOID", "med_price_25", "min_price_25", "med_price_100", "min_price_100_plus", "min_price_100")], by.x = "tract", by.y = "GEOID") %>% 
  gather(measure, value, c(med_price_25, min_price_25, med_price_100, min_price_100_plus, min_price_100)) %>%
  mutate(perc_annual_income = ifelse(value / median_household_incomeE * 100 * 12 > 0, value / median_household_incomeE * 100 * 12, NA)) %>%
  select(-c(median_household_incomeE, value, median_household_incomeM, popE, popM, tract)) %>%
  mutate(measure = paste0("perc_income_", measure), measure_type = "percent", measure_units = as.character(NA), region_type = "block group", year = 2021) %>%
  rename(value = perc_annual_income, geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  drop_na(value)

md.bg.price_inc <- st_drop_geometry(md.bg) %>%
  mutate(tract = substr(GEOID, 1, 11)) %>%
  merge(st_drop_geometry(md_prices)[, c("GEOID", "med_price_25", "min_price_25", "med_price_100", "min_price_100_plus", "min_price_100")], by.x = "tract", by.y = "GEOID") %>% 
  gather(measure, value, c(med_price_25, min_price_25, med_price_100, min_price_100_plus, min_price_100)) %>%
  mutate(perc_annual_income = ifelse(value / median_household_incomeE * 100 * 12 > 0, value / median_household_incomeE * 100 * 12, NA)) %>%
  select(-c(median_household_incomeE, value, median_household_incomeM, popE, popM, tract)) %>%
  mutate(measure = paste0("perc_income_", measure), measure_type = "percent", measure_units = as.character(NA), region_type = "block group", year = 2021) %>%
  rename(value = perc_annual_income, geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units") %>%
  drop_na(value)

con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
dc_dbWriteTable(con, "dc_digital_communications", "va_bg_sdad_2021_perc_income_on_internet", va.bg.price_inc)
dc_dbWriteTable(con, "dc_digital_communications", "md_bg_sdad_2021_perc_income_on_internet", md.bg.price_inc)
dc_dbWriteTable(con, "dc_digital_communications", "dc_bg_sdad_2021_perc_income_on_internet", dc.bg.price_inc)
dc_dbWriteTable(con, "dc_digital_communications", "ncr_bg_sdad_2021_perc_income_on_internet", ncr.bg.price_inc)
dbDisconnect(con)
```


# WHAT TO DO ABOUT TRACTS WITH MISSING PACKAGE DATA??? - I think that I fixed this!!! (need to check over the last few census tracts where things are different for whatever reason...)

# add information on people with aid???
```{r}
dmv.tr.aid <- get_acs(geography = "tract",
                       year = 2019,
                       variables = c(total_SSI = "B19056_001",
                                     w_SSI = "B19056_002",
                                     total_PAI = "B19057_001",
                                     w_PAI = "B19057_002",
                                     total_SNAP = "B19058_001",
                                     w_SNAP = "B19058_002",
                                     total_medicaid = "C27007_001",
                                     male_under19 = "C27007_004",
                                     male_19_64 = "C27007_007",
                                     male_over64 = "C27007_010",
                                     female_under19 = "C27007_014",
                                     female_19_64 = "C27007_017",
                                     female_over64 = "C27007_020"),
                      state = c("VA", "DC", "MD"),
                      survey = "acs5",
                      output = "wide",
                      geometry = TRUE)

dmv.tr.aid2 <- st_drop_geometry(dmv.tr.aid) %>%
  mutate(perc_SSI = 100 * w_SSIE / total_SSIE, perc_PAI = 100 * w_PAIE / total_PAIE, perc_SNAP = 100 * w_SNAPE / total_SNAPE,
         perc_medicaid = 100 * (male_under19E + male_19_64E + male_over64E + female_under19E + female_19_64E + female_over64E) / total_medicaidE) %>%
  select(c(GEOID, NAME, perc_SSI, perc_PAI, perc_SNAP, perc_medicaid)) %>%
  mutate(perc_max_disadv = pmax(perc_SSI, perc_PAI, perc_SNAP, perc_medicaid, na.rm = T)) %>%
  drop_na() %>%
  gather(measure, value, c(perc_SSI, perc_PAI, perc_SNAP, perc_medicaid, perc_max_disadv)) %>%
  mutate(year = 2019, measure_type = "percent", measure_units = as.character(NA), region_type = "tract") %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")

ncr.tr.aid <- dmv.tr.aid2[substr(dmv.tr.aid2$geoid, 1, 5) %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]
va.tr.aid <- dmv.tr.aid2[substr(dmv.tr.aid2$geoid, 1, 2) == "51",]
dc.tr.aid <- dmv.tr.aid2[substr(dmv.tr.aid2$geoid, 1, 2) ==  "11",]
md.tr.aid <- dmv.tr.aid2[substr(dmv.tr.aid2$geoid, 1, 2) == "24",]

# con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
# dc_dbWriteTable(con, "dc_digital_communications", "va_tr_acs_2021_perc_qualifying_for_internet_aid", va.tr.aid)
# dc_dbWriteTable(con, "dc_digital_communications", "md_tr_acs_2021_perc_qualifying_for_internet_aid", md.tr.aid)
# dc_dbWriteTable(con, "dc_digital_communications", "dc_tr_acs_2021_perc_qualifying_for_internet_aid", dc.tr.aid)
# dc_dbWriteTable(con, "dc_digital_communications", "ncr_tr_acs_2021_perc_qualifying_for_internet_aid", ncr.tr.aid)
# dbDisconnect(con)

dmv.ct.aid <- get_acs(geography = "county",
                       year = 2019,
                       variables = c(total_SSI = "B19056_001",
                                     w_SSI = "B19056_002",
                                     total_PAI = "B19057_001",
                                     w_PAI = "B19057_002",
                                     total_SNAP = "B19058_001",
                                     w_SNAP = "B19058_002",
                                     total_medicaid = "C27007_001",
                                     male_under19 = "C27007_004",
                                     male_19_64 = "C27007_007",
                                     male_over64 = "C27007_010",
                                     female_under19 = "C27007_014",
                                     female_19_64 = "C27007_017",
                                     female_over64 = "C27007_020"),
                      state = c("VA", "DC", "MD"),
                      survey = "acs5",
                      output = "wide",
                      geometry = TRUE)

dmv.ct.aid2 <- st_drop_geometry(dmv.ct.aid) %>%
  mutate(perc_SSI = 100 * w_SSIE / total_SSIE, perc_PAI = 100 * w_PAIE / total_PAIE, perc_SNAP = 100 * w_SNAPE / total_SNAPE,
         perc_medicaid = 100 * (male_under19E + male_19_64E + male_over64E + female_under19E + female_19_64E + female_over64E) / total_medicaidE) %>%
  select(c(GEOID, NAME, perc_SSI, perc_PAI, perc_SNAP, perc_medicaid)) %>%
  mutate(perc_max_disadv = pmax(perc_SSI, perc_PAI, perc_SNAP, perc_medicaid, na.rm = T)) %>%
  drop_na() %>%
  gather(measure, value, c(perc_SSI, perc_PAI, perc_SNAP, perc_medicaid, perc_max_disadv)) %>%
  mutate(year = 2019, measure_type = "percent", measure_units = as.character(NA), region_type = "county") %>%
  rename(geoid = GEOID, region_name = NAME) %>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")

ncr.ct.aid <- dmv.ct.aid2[substr(dmv.ct.aid2$geoid, 1, 5) %in% c("51013", "51059", "51107", "51510", "51600", "51153", "51683", "51685", "51610", "11001", "24031", "24033", "24017", "24021"),]
va.ct.aid <- dmv.ct.aid2[substr(dmv.ct.aid2$geoid, 1, 2) == "51",]
dc.ct.aid <- dmv.ct.aid2[substr(dmv.ct.aid2$geoid, 1, 2) ==  "11",]
md.ct.aid <- dmv.ct.aid2[substr(dmv.ct.aid2$geoid, 1, 2) == "24",]

# con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
# dc_dbWriteTable(con, "dc_digital_communications", "va_ct_acs_2021_perc_qualifying_for_internet_aid", va.ct.aid)
# dc_dbWriteTable(con, "dc_digital_communications", "md_ct_acs_2021_perc_qualifying_for_internet_aid", md.ct.aid)
# dc_dbWriteTable(con, "dc_digital_communications", "dc_ct_acs_2021_perc_qualifying_for_internet_aid", dc.ct.aid)
# dc_dbWriteTable(con, "dc_digital_communications", "ncr_ct_acs_2021_perc_qualifying_for_internet_aid", ncr.ct.aid)
# dbDisconnect(con)
```

# can we get data at the block group level AND health districts within VA
```{r}
# Not at bg level, so what do we do???
dmv.bg.aid <- get_acs(geography = "block group",
                       year = 2019,
                       variables = c(total_SSI = "B19056_001",
                                     w_SSI = "B19056_002",
                                     total_PAI = "B19057_001",
                                     w_PAI = "B19057_002",
                                     total_SNAP = "B19058_001",
                                     w_SNAP = "B19058_002",
                                     total_medicaid = "C27007_001",
                                     male_under19 = "C27007_004",
                                     male_19_64 = "C27007_007",
                                     male_over64 = "C27007_010",
                                     female_under19 = "C27007_014",
                                     female_19_64 = "C27007_017",
                                     female_over64 = "C27007_020"),
                      state = c("VA", "DC", "MD"),
                      survey = "acs5",
                      output = "wide",
                      geometry = TRUE)

# dmv.bg.aid
# 
# dmv.tr.aid

# health district level

va.hd.aid <- st_drop_geometry(dmv.ct.aid) %>%
  merge(health_district, by.x = "GEOID", by.y = "county_id") %>%
  rename(region_name = health_district) %>%
  group_by(region_name) %>%
  summarize(total_SSI = sum(total_SSIE), w_SSI = sum(w_SSIE), total_PAI = sum(total_PAIE), w_PAI = sum(w_PAIE),
            total_SNAP = sum(total_SNAPE), w_SNAP = sum(w_SNAPE), total_medicaid = sum(total_medicaidE),
            w_medicaid = sum(male_under19E) + sum(male_19_64E) + sum(male_over64E) + sum(female_under19E) + sum(female_19_64E) + sum(female_over64E)) %>%
  mutate(perc_SSI = 100 * w_SSI / total_SSI, perc_PAI = 100 * w_PAI / total_PAI,
         perc_SNAP = 100 * w_SNAP / total_SNAP, perc_medicaid = 100 * w_medicaid / total_medicaid) %>%
  select(c(region_name, perc_SSI, perc_PAI, perc_SNAP, perc_medicaid)) %>%
  mutate(perc_max_disadv = pmax(perc_SSI, perc_PAI, perc_SNAP, perc_medicaid, na.rm = T)) %>%
  drop_na() %>%
  gather(measure, value, c(perc_SSI, perc_PAI, perc_SNAP, perc_medicaid, perc_max_disadv)) %>%
  mutate(year = 2019, measure_type = "percent", measure_units = as.character(NA)) %>%
  merge(health_district_geoids, by = "region_name")%>%
  relocate("geoid", "region_type", "region_name", "year", "measure", "value", "measure_type", "measure_units")

# con <- get_db_conn(db_pass = "rsu8zvrsu8zv")
# dc_dbWriteTable(con, "dc_digital_communications", "va_hd_acs_2021_perc_qualifying_for_internet_aid", va.hd.aid)
# dbDisconnect(con)

# va.hd.aid
```





